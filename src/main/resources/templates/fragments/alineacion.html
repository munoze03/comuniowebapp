<div th:fragment="alineacionFragment">
    <section class="resume-section" id="alineacion">
        <div class="resume-section-content">
            <h2 class="mb-3">Alineación</h2>

            <div th:if="${alineacion != null}">
                <!-- Selector de táctica -->
                <div class="selector-tactica">
                    <label for="tactica">Elige táctica:</label>
                    <select id="tactica" class="form-select form-select-sm w-auto"
                            onchange="cambiarFormacion(this.value)">
                        <option value="343" th:selected="${alineacion[0].tactic == '343'}">3-4-3</option>
                        <option value="352" th:selected="${alineacion[0].tactic == '352'}">3-5-2</option>
                        <option value="433" th:selected="${alineacion[0].tactic == '433'}">4-3-3</option>
                        <option value="442" th:selected="${alineacion[0].tactic == '442'}">4-4-2</option>
                        <option value="451" th:selected="${alineacion[0].tactic == '451'}">4-5-1</option>
                    </select>
                </div>

                <!-- Cancha -->
                <div class="alineacion-container">
                    <div class="cancha" id="cancha">
                        <!-- Elementos del campo -->
                        <div class="linea-media"></div>
                        <div class="centro-campo"></div>
                        <div class="punto-centro"></div>
                        <div class="area-grande area-grande-top"></div>
                        <div class="area-pequena area-pequena-top"></div>
                        <div class="area-grande area-grande-bottom"></div>
                        <div class="area-pequena area-pequena-bottom"></div>
                    </div>
                </div>

                <!-- Puntos Live 
                <div class="selector-tactica">
                    <label for="livePoints">Puntos Live:</label>
                    <span id="livePoints" style="color: #20c997; font-weight: bold;">0</span>
                </div> -->

                <!-- Formulario de alineación -->
                <form th:action="@{/alineacion/modificar}" method="post" class="mb-2 selector-tactica" id="formAlineacion">
                    <!-- Input oculto para táctica seleccionada -->
                    <input type="hidden" name="tactic" id="inputTacticHidden"
                        th:value="${alineacion[0].tactic}" />

                    <input type="hidden" name="type" value="default" />

                    <!-- Titulares: alineacion[i].id debe ser el id del jugador (String) -->
                    <th:block th:each="i : ${#numbers.sequence(0, 9)}">
                        <input type="hidden"
                            th:name="'lineup[' + (${i} + 1) + ']'"
                            th:value="${alineacion[9 - i] != null ? alineacion[9 - i].id : ''}" />
                    </th:block>
                    <!-- Suplentes en caso de comunio premium (comenta si no lo usas) -->
                    <input type="hidden" name="substitutes[striker]" value="" />
                    <input type="hidden" name="substitutes[midfielder]" value="" />
                    <input type="hidden" name="substitutes[defender]" value="" />
                    <input type="hidden" name="substitutes[keeper]" value="" />
                    
                    <button type="submit" class="btn btn-success selector-tactica">
                        Guardar alineación
                    </button>
                </form> 
            </div>

            <div th:if="${alineacion == null}" class="alert alert-warning">
                No tienes una alineación configurada actualmente.
            </div>
        </div>
    </section>
    <hr class="m-0" />

    <!-- Modal de información del jugador -->
    <div th:replace="fragments/jugadorModal :: jugadorModal"></div>

    <!-- Inyectamos jugadores desde Thymeleaf en JSON -->
    <script th:inline="javascript">
        window.jugadores = /*[[${alineacion}]]*/ [];
        window.plantilla = /*[[${plantilla}]]*/ [];
    </script>
    <script>
        // Copia la táctica seleccionada al hidden antes de enviar el form
        document.getElementById("formAlineacion").addEventListener("submit", function(e) {
            var tacticaSeleccionada = document.getElementById("tactica").value;
            document.getElementById("inputTacticHidden").value = tacticaSeleccionada;
        });
    </script>
</div>
